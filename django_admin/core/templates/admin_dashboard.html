<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin Dashboard • Learning Platform</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="/static/css/styles.css" />
  </head>
  <body class="bg-light">
    <header class="border-bottom bg-white">
      <nav class="navbar navbar-expand-lg">
        <div class="container">
          <a class="navbar-brand fw-semibold" href="/admin/">django_admin</a>
          <span class="navbar-text text-secondary">Dashboard</span>
        </div>
      </nav>
    </header>

    <main class="container py-4">
      <div class="p-4 mb-4 rounded-3 shadow-sm bg-white border">
        <h4 class="mb-1">Overview</h4>
        <p class="mb-0 text-secondary">Track activity and manage content with quick actions.</p>
      </div>
      <div class="row g-3">
        <div class="col-md-4">
          <div class="card shadow-sm border">
            <div class="card-body">
              <h6 class="card-subtitle text-muted mb-2">Total Users</h6>
              <h2 class="card-title">{{ total_users }}</h2>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card shadow-sm border">
            <div class="card-body">
              <h6 class="card-subtitle text-muted mb-2">Total Courses</h6>
              <h2 class="card-title">{{ total_courses }}</h2>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card shadow-sm border">
            <div class="card-body">
              <h6 class="card-subtitle text-muted mb-2">Total Enrollments</h6>
              <h2 class="card-title">{{ total_enrollments }}</h2>
            </div>
          </div>
        </div>
      </div>

      <div class="row mt-4">
        <div class="col-12">
          <div class="card shadow-sm border">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="card-title mb-0">Top Enrolled Courses</h5>
                <a class="btn btn-sm btn-primary" href="/admin/lms/course/">Manage</a>
              </div>
              <canvas id="topCoursesChart" height="120"></canvas>
            </div>
          </div>
        </div>
      </div>

      <div class="row mt-4 g-3">
        <div class="col-md-6">
          <div class="card shadow-sm border">
            <div class="card-body">
              <h5 class="card-title mb-3">Monthly Revenue (INR)</h5>
              <canvas id="revenueChart" height="140"></canvas>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card shadow-sm border">
            <div class="card-body">
              <h5 class="card-title mb-3">Activity Trend</h5>
              <canvas id="activityChart" height="140"></canvas>
            </div>
          </div>
        </div>
      </div>

      <div class="row mt-3">
        <div class="col-12">
          <div class="card shadow-sm border">
            <div class="card-body">
              <h6 class="text-muted mb-3">Quick Actions</h6>
              <div class="d-flex flex-wrap gap-2">
                <a href="/admin/lms/course/add/" class="btn btn-outline-primary">New Course</a>
                <a href="/admin/lms/lmsuser/add/" class="btn btn-outline-primary">New User</a>
                <a href="/admin/lms/enrollment/" class="btn btn-outline-primary">Enrollments</a>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row mt-3">
        <div class="col-12">
          <div class="card shadow-sm border">
            <div class="card-body">
              <h6 class="text-muted mb-3">Recent Notifications</h6>
              {% if recent_notifications %}
                <ul class="list-group list-group-flush">
                  {% for n in recent_notifications %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                      <span>{{ n.created_at|date:"Y-m-d H:i" }} — {{ n.user.name }}: {{ n.message }}</span>
                      {% if not n.is_read %}<span class="badge bg-primary rounded-pill">new</span>{% endif %}
                    </li>
                  {% endfor %}
                </ul>
              {% else %}
                <p class="text-muted mb-0">No notifications yet.</p>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script>
      const data = {{ top_courses|safe }};
      const labels = data.map(d => d.title);
      const values = data.map(d => d.enroll_count);
      const ctx = document.getElementById('topCoursesChart').getContext('2d');
      const colors = ['#2E86C1','#5DADE2','#85C1E9','#A9CCE3','#D6EAF8','#EBF5FB'];
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'Enrollments',
            data: values,
            backgroundColor: colors,
            borderRadius: 6
          }]
        },
        options: {
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true } }
        }
      });

      const rev = {{ revenue_series|safe }};
      const rlabels = rev.map(d => d.label);
      const rvalues = rev.map(d => d.value);
      new Chart(document.getElementById('revenueChart').getContext('2d'), {
        type: 'line',
        data: { labels: rlabels, datasets: [{ label: 'Revenue (₹)', data: rvalues, borderColor: '#2E86C1', tension: .35 }]},
        options: { plugins:{legend:{display:false}}, scales:{ y:{beginAtZero:true}}}
      });

      const act = {{ activity_series|safe }};
      const alabels = act.map(d => d.label);
      const avalues = act.map(d => d.value);
      new Chart(document.getElementById('activityChart').getContext('2d'), {
        type: 'line',
        data: { labels: alabels, datasets: [{ label: 'Events', data: avalues, borderColor: '#5DADE2', tension: .35 }]},
        options: { plugins:{legend:{display:false}}, scales:{ y:{beginAtZero:true}}}
      });
    </script>
  </body>
</html>